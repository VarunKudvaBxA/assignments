WITH monthly_orders AS (
    SELECT
        customer_state,
        DATE_TRUNC('month', order_purchase_timestamp) AS month,
        COUNT(order_id) AS order_count
    FROM orders
    GROUP BY customer_state, DATE_TRUNC('month', order_purchase_timestamp)
),
growth_states AS (
    SELECT
        o1.customer_state
    FROM monthly_orders o1
    JOIN monthly_orders o2
      ON o1.customer_state = o2.customer_state
     AND o1.month = DATE '2017-11-01'
     AND o2.month = DATE '2017-12-01'
    WHERE (o2.order_count - o1.order_count) * 1.0 / o1.order_count > 0.05
),
top_categories AS (
    SELECT
        o.customer_state,
        p.product_category_name,
        SUM(oi.price) AS total_revenue,
        ROW_NUMBER() OVER (PARTITION BY o.customer_state ORDER BY SUM(oi.price) DESC) AS rank
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    JOIN products p ON oi.product_id = p.product_id
    WHERE o.customer_state IN (SELECT customer_state FROM growth_states)
    GROUP BY o.customer_state, p.product_category_name
)

SELECT customer_state, product_category_name, total_revenue
FROM top_categories
WHERE rank <= 3
ORDER BY customer_state, total_revenue DESC;


-- Task 2: First-Purchase Preferences of High vs Low Value Customers
WITH customer_orders AS (
    SELECT
        customer_unique_id,
        COUNT(DISTINCT order_id) AS order_count,
        SUM(payment_value) AS total_spent
    FROM orders o
    JOIN order_payments op ON o.order_id = op.order_id
    GROUP BY customer_unique_id
),
customer_type AS (
    SELECT
        customer_unique_id,
        CASE
            WHEN order_count >= 2 THEN 'High-Value'
            WHEN order_count = 1 AND total_spent < 100 THEN 'Low-Value'
        END AS customer_segment
    FROM customer_orders
),
first_orders AS (
    SELECT DISTINCT ON (customer_unique_id)
        o.customer_unique_id,
        o.order_id,
        o.order_purchase_timestamp
    FROM orders o
    ORDER BY customer_unique_id, o.order_purchase_timestamp
),
first_order_categories AS (
    SELECT
        ct.customer_segment,
        p.product_category_name,
        COUNT(*) AS category_count,
        ROW_NUMBER() OVER (PARTITION BY ct.customer_segment ORDER BY COUNT(*) DESC) AS rank
    FROM first_orders fo
    JOIN customer_type ct ON fo.customer_unique_id = ct.customer_unique_id
    JOIN order_items oi ON fo.order_id = oi.order_id
    JOIN products p ON oi.product_id = p.product_id
    WHERE ct.customer_segment IS NOT NULL
    GROUP BY ct.customer_segment, p.product_category_name
)

SELECT customer_segment, product_category_name, category_count
FROM first_order_categories
WHERE rank <= 3
ORDER BY customer_segment, category_count DESC;



